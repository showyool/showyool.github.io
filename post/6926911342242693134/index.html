<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Showyool个人博客">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="http://showyool.github.io//img/home-bg-jeep.jpg">
    <meta property="twitter:image" content="http://showyool.github.io//img/home-bg-jeep.jpg" />
    

    
    <meta name="title" content="【硬核】由XSS问题探索一下SpringMVC和FastJson" />
    <meta property="og:title" content="【硬核】由XSS问题探索一下SpringMVC和FastJson" />
    <meta property="twitter:title" content="【硬核】由XSS问题探索一下SpringMVC和FastJson" />
    

    
    <meta name="description" content="Showyool，Java高级开发, 开源爱好者，生活探险家 | 这里是Showyool的博客，代码改变世界。">
    <meta property="og:description" content="Showyool，Java高级开发, 开源爱好者，生活探险家 | 这里是Showyool的博客，代码改变世界。" />
    <meta property="twitter:description" content="Showyool，Java高级开发, 开源爱好者，生活探险家 | 这里是Showyool的博客，代码改变世界。" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="Showyool, showyool, mengyirunian, 浮沉, Showyool Blog, 博客, 个人网站, 互联网, Web, Tomcat, Spring, Java, MySQL, 微服务, Dubbo">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>【硬核】由XSS问题探索一下SpringMVC和FastJson-showyool的博客 | Showyool Blog</title>

    <link rel="canonical" href="/post/6926911342242693134/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">
    
    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>



<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Showyool个人博客</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                    
                    
		    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/home-bg-jeep.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/java" title="Java">
                            Java
                        </a>
                        
                    </div>
                    <h1>【硬核】由XSS问题探索一下SpringMVC和FastJson</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by 
                        
                            showyool
                         
                        on 
                        Monday, February 8, 2021
                        
                        
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h2>TOC</h2>
                </header>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#背景">背景</a></li>
    <li><a href="#需求分析">需求分析</a></li>
    <li><a href="#源码探索">源码探索</a>
      <ul>
        <li><a href="#json数据返回">JSON数据返回</a></li>
        <li><a href="#json数据请求">JSON数据请求</a></li>
      </ul>
    </li>
    <li><a href="#小结">小结</a></li>
    <li><a href="#最后">最后</a></li>
  </ul>
</nav>
                
                <h1 id="前言">前言</h1>
<p>好久没来写文章了，所以在某人的催促之下，把最近的一个需求进行总结一下。在这个需求的开发过程中，还是有不少收获的，所以做一下分享，如有补充与不正之处，欢迎大家的批评与斧正。<!-- raw HTML omitted -->

  <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b4c902e655e43718041a24110b92319~tplv-k3u1fbpfcp-watermark.image" alt="">

</p>
<h1 id="背景">背景</h1>
<p>我们先来讲一下这个需求的背景吧。看到这个标题，可以想到是不是因为系统遭遇了XSS攻击所以需要进行过滤。没错，这是因为前几天有一个憨批提交了一段含有<!-- raw HTML omitted -->alert(&lsquo;xxx&rsquo;)<!-- raw HTML omitted -->脚本的内容，结果成功保存进去，然后在展示的时候，浏览器直接alert出来这个提示（传统项目中的常见漏洞，见谅见谅），这个也是比较常见的XSS攻击的场景。为此，需要对XSS的内容进行过滤，以及对系统内的脏数据进行兼容处理（后来在系统里仔细搜了下，还确实有不少XSS的内容，估计是友商的友善操作）。

  <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1066235e05a3460a97d7ffb6344885a8~tplv-k3u1fbpfcp-watermark.image" alt="">

</p>
<h1 id="需求分析">需求分析</h1>
<p>看到这里，估计有不少小伙伴嗤之以鼻，心里在想：这个东西对我来说实在是太小儿科了。于是百度一下，啪的一声就把代码甩在我的脸上。这些答案，大致上是这样的：提供一个Xss的Filter，然后在这个Filter里面对Request进行RequestWrapper的封装，并且重写里面的getParameter方法和getParameterValues方法，然后对参数值进行Xss数据清洗。代码如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">XssFilter</span> <span style="color:#8be9fd;font-style:italic">implements</span> Filter <span style="color:#ff79c6">{</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">init</span><span style="color:#ff79c6">(</span>FilterConfig filterConfig<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> ServletException <span style="color:#ff79c6">{</span>
        Assert<span style="color:#ff79c6">.</span><span style="color:#50fa7b">notNull</span><span style="color:#ff79c6">(</span>filterConfig<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;FilterConfig must not be null&#34;</span><span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 普通代码块
</span><span style="color:#6272a4"></span>            String temp <span style="color:#ff79c6">=</span> filterConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInitParameter</span><span style="color:#ff79c6">(</span>PARAM_NAME_EXCLUSIONS<span style="color:#ff79c6">);</span>
            String<span style="color:#ff79c6">[]</span> url <span style="color:#ff79c6">=</span> StringUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">split</span><span style="color:#ff79c6">(</span>temp<span style="color:#ff79c6">,</span> DEFAULT_SEPARATOR_CHARS<span style="color:#ff79c6">);</span>
            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> url <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> i <span style="color:#ff79c6">&lt;</span> url<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
                excludes<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>url<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]);</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;WebFilter-&gt;[{}] init success...&#34;</span><span style="color:#ff79c6">,</span> filterConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getFilterName</span><span style="color:#ff79c6">());</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">doFilter</span><span style="color:#ff79c6">(</span>ServletRequest request<span style="color:#ff79c6">,</span> ServletResponse response<span style="color:#ff79c6">,</span> FilterChain chain<span style="color:#ff79c6">)</span>
            <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> ServletException <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>request <span style="color:#ff79c6">instanceof</span> HttpServletRequest <span style="color:#ff79c6">&amp;&amp;</span> response <span style="color:#ff79c6">instanceof</span> HttpServletResponse<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            HttpServletRequest req <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>HttpServletRequest<span style="color:#ff79c6">)</span> request<span style="color:#ff79c6">;</span>
            HttpServletResponse resp <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>HttpServletResponse<span style="color:#ff79c6">)</span> response<span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>handleExcludeUrl<span style="color:#ff79c6">(</span>req<span style="color:#ff79c6">,</span> resp<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
                chain<span style="color:#ff79c6">.</span><span style="color:#50fa7b">doFilter</span><span style="color:#ff79c6">(</span>request<span style="color:#ff79c6">,</span> response<span style="color:#ff79c6">);</span>
                <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
            <span style="color:#6272a4">// 对HttpServletRequest进行包装
</span><span style="color:#6272a4"></span>            XssHttpServletRequestWrapper xssRequest <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> XssHttpServletRequestWrapper<span style="color:#ff79c6">((</span>HttpServletRequest<span style="color:#ff79c6">)</span> request<span style="color:#ff79c6">);</span>
            chain<span style="color:#ff79c6">.</span><span style="color:#50fa7b">doFilter</span><span style="color:#ff79c6">(</span>xssRequest<span style="color:#ff79c6">,</span> response<span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
            chain<span style="color:#ff79c6">.</span><span style="color:#50fa7b">doFilter</span><span style="color:#ff79c6">(</span>request<span style="color:#ff79c6">,</span> response<span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 当前请求是否是排除的链接
</span><span style="color:#6272a4">     *
</span><span style="color:#6272a4">     * @return boolean
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">handleExcludeUrl</span><span style="color:#ff79c6">(</span>HttpServletRequest request<span style="color:#ff79c6">,</span> HttpServletResponse response<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        Assert<span style="color:#ff79c6">.</span><span style="color:#50fa7b">notNull</span><span style="color:#ff79c6">(</span>request<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;HttpServletRequest must not be null&#34;</span><span style="color:#ff79c6">);</span>
        Assert<span style="color:#ff79c6">.</span><span style="color:#50fa7b">notNull</span><span style="color:#ff79c6">(</span>response<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;HttpServletResponse must not be null&#34;</span><span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>ObjectUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isEmpty</span><span style="color:#ff79c6">(</span>excludes<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#6272a4">// 返回除去host（域名或者ip）部分的路径
</span><span style="color:#6272a4"></span>        String requestUri <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getRequestURI</span><span style="color:#ff79c6">();</span>
        <span style="color:#6272a4">// 返回除去host和工程名部分的路径
</span><span style="color:#6272a4"></span>        String servletPath <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getServletPath</span><span style="color:#ff79c6">();</span>
        <span style="color:#6272a4">// 返回全路径
</span><span style="color:#6272a4"></span>        StringBuffer requestURL <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getRequestURL</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>String pattern <span style="color:#ff79c6">:</span> excludes<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            Pattern p <span style="color:#ff79c6">=</span> Pattern<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compile</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;^&#34;</span> <span style="color:#ff79c6">+</span> pattern<span style="color:#ff79c6">);</span>
            Matcher m <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">matcher</span><span style="color:#ff79c6">(</span>requestURL<span style="color:#ff79c6">);</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>m<span style="color:#ff79c6">.</span><span style="color:#50fa7b">find</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">destroy</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 排除链接默认分隔符
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String DEFAULT_SEPARATOR_CHARS <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;,&#34;</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 需要忽略排除的链接参数名
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String PARAM_NAME_EXCLUSIONS <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;exclusions&#34;</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 需要忽略排除的链接参数值
</span><span style="color:#6272a4">     * http://localhost,http://127.0.0.1,
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String PARAM_VALUE_EXCLUSIONS <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 排除链接
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> List<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> excludes <span style="color:#ff79c6">=</span> Lists<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newArrayList</span><span style="color:#ff79c6">();</span>

<span style="color:#ff79c6">}</span>
</code></pre></div><p>XssHttpServletRequestWrapper的代码如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">import</span> org.apache.commons.lang3.StringUtils<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">import</span> org.jsoup.Jsoup<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">import</span> org.jsoup.safety.Whitelist<span style="color:#ff79c6">;</span>

<span style="color:#ff79c6">import</span> javax.servlet.ServletInputStream<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">import</span> javax.servlet.http.HttpServletRequest<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">import</span> javax.servlet.http.HttpServletRequestWrapper<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">import</span> java.util.Enumeration<span style="color:#ff79c6">;</span>

<span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * XSS过滤处理
</span><span style="color:#6272a4"> *
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">XssHttpServletRequestWrapper</span> <span style="color:#8be9fd;font-style:italic">extends</span> HttpServletRequestWrapper <span style="color:#ff79c6">{</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 默认XSS过滤处理白名单
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd;font-style:italic">static</span> Whitelist DEFAULT_WHITE_LIST <span style="color:#ff79c6">=</span> Whitelist<span style="color:#ff79c6">.</span><span style="color:#50fa7b">relaxed</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">addAttributes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;:all&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;style&#34;</span><span style="color:#ff79c6">);</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 唯一构造器
</span><span style="color:#6272a4">     *
</span><span style="color:#6272a4">     * @param request HttpServletRequest
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">XssHttpServletRequestWrapper</span><span style="color:#ff79c6">(</span>HttpServletRequest request<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">(</span>request<span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">getHeader</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getHeader</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> Enumeration<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">getHeaders</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getHeaders</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">getRequestURI</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getRequestURI</span><span style="color:#ff79c6">();</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 需要手动调用此方法，SpringMVC默认应该使用getParameterValues来封装的Model
</span><span style="color:#6272a4">     */</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">getParameter</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String parameter <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getParameter</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>parameter <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span> cleanXSS<span style="color:#ff79c6">(</span>parameter<span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> String<span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">getParameterValues</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String<span style="color:#ff79c6">[]</span> values <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getParameterValues</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>values <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#8be9fd">int</span> length <span style="color:#ff79c6">=</span> values<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span>
            String<span style="color:#ff79c6">[]</span> escapeValues <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">[</span>length<span style="color:#ff79c6">];</span>
            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> length<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span> <span style="color:#ff79c6">!=</span> values<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">])</span> <span style="color:#ff79c6">{</span>
                    <span style="color:#6272a4">// 防xss攻击和过滤前后空格
</span><span style="color:#6272a4"></span>                    escapeValues<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> cleanXSS<span style="color:#ff79c6">(</span>values<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]);</span>
                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
                    escapeValues<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">return</span> escapeValues<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> ServletInputStream <span style="color:#50fa7b">getInputStream</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInputStream</span><span style="color:#ff79c6">();</span>
    <span style="color:#ff79c6">}</span>
    

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">cleanXSS</span><span style="color:#ff79c6">(</span>String value<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            value <span style="color:#ff79c6">=</span> StringUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">trim</span><span style="color:#ff79c6">(</span>Jsoup<span style="color:#ff79c6">.</span><span style="color:#50fa7b">clean</span><span style="color:#ff79c6">(</span>value<span style="color:#ff79c6">,</span> DEFAULT_WHITE_LIST<span style="color:#ff79c6">));</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">return</span> value<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>当然，这里我就使用了Jsoup作为XSS内容清除的工具，具体的用法，各位可以自行百度。<!-- raw HTML omitted -->

  <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6fb6baf0bb2b477c9ae972d6c2ec96ca~tplv-k3u1fbpfcp-watermark.image" alt="">


<!-- raw HTML omitted -->
我想以上应该是各位比较常见的写法。这样的写法当然没啥问题，但是其实有一个局限性，那就是这种方式只适合form表单提交的请求，而如果是那种JSON数据请求的，就获取不到数据，而我们系统大多数的接口请求都是JSON数据提交的。
<!-- raw HTML omitted -->
此外还有一个问题，那就是我们系统里面已经有XSS脏数据了，那么要解决这个问题，也是两个角度出发:<!-- raw HTML omitted --></p>
<ol>
<li>处理系统当中的脏数据，也就是SQL清洗.
2.在数据返回的时候进行数据清洗.</li>
</ol>
<p>对于第一种方案，由于系统是分库分表，而且期间的业务表冗余庞大，SQL的清除工作会显得十分困难，而且存在巨大的风险与隐患。所以我们这边还是采用第二种方案，由于数据都是采用JSON数据返回，那么只需要做一个通用的转换，进行数据清洗即可。<!-- raw HTML omitted -->
那么我们对需要做的事情进行数据总结一下:</p>
<ol>
<li>对于JSON数据请求进行数据清洗</li>
<li>对于JSON数据返回进行数据清洗</li>
</ol>
<h1 id="源码探索">源码探索</h1>
<p>按照我以往设计解决方案的时候，我都会先从执行流程以及源码等方面来看这些问题。所以我想对于JSON的请求和返回的过程进行的探索可能会有所启示。目前大多数系统都是基于SpringMVC作为前置框架，所以以下也是基于SpringMVC的源码进行解析，spring-webmvc的版本是5.2.9.RELEASE，其他版本的代码应该大致相同，就不做过多细究。在JSON数据上我们使用的是fastjson（虽然fastjson在稳定性等方面还是不如jackson，但是我希望我们国产的能够越来越好，还是要支持一波），使用的版本是1.2.72。<!-- raw HTML omitted -->

  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8ae022e58851460d97f4147621b628a9~tplv-k3u1fbpfcp-watermark.image" alt="">

</p>
<h2 id="json数据返回">JSON数据返回</h2>
<p>首先我们还是先从JSON数据返回开始着手，这个也是因为，即便无法完成对JSON数据请求的数据清洗，能够从JSON数据返回当中解决，进行一个兜底的方案处理，至少还是一个让人安心的事情。<!-- raw HTML omitted -->
SpringMVC在扫描到@ResponseBody之后，就知道这个接口是用来返回JSON数据的。在spring配置文件中，我们配置了如下: <!-- raw HTML omitted --></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#ff79c6">&lt;bean</span> <span style="color:#50fa7b">id=</span><span style="color:#f1fa8c">&#34;fastJsonHttpMessageConverter&#34;</span>
      <span style="color:#50fa7b">class=</span><span style="color:#f1fa8c">&#34;com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter&#34;</span><span style="color:#ff79c6">&gt;</span>
    <span style="color:#ff79c6">&lt;property</span> <span style="color:#50fa7b">name=</span><span style="color:#f1fa8c">&#34;supportedMediaTypes&#34;</span><span style="color:#ff79c6">&gt;</span>
        <span style="color:#ff79c6">&lt;list&gt;</span>
            <span style="color:#ff79c6">&lt;value&gt;</span>text/html;charset=UTF-8<span style="color:#ff79c6">&lt;/value&gt;</span>
            <span style="color:#ff79c6">&lt;value&gt;</span>application/json;charset=UTF-8<span style="color:#ff79c6">&lt;/value&gt;</span>
        <span style="color:#ff79c6">&lt;/list&gt;</span>
    <span style="color:#ff79c6">&lt;/property&gt;</span>
    <span style="color:#ff79c6">&lt;property</span> <span style="color:#50fa7b">name=</span><span style="color:#f1fa8c">&#34;features&#34;</span><span style="color:#ff79c6">&gt;</span>
        <span style="color:#ff79c6">&lt;array&gt;</span>
            <span style="color:#ff79c6">&lt;value&gt;</span>DisableCircularReferenceDetect<span style="color:#ff79c6">&lt;/value&gt;</span>
        <span style="color:#ff79c6">&lt;/array&gt;</span>
    <span style="color:#ff79c6">&lt;/property&gt;</span>
<span style="color:#ff79c6">&lt;/bean&gt;</span>

<span style="color:#ff79c6">&lt;mvc:annotation-driven&gt;</span>
    <span style="color:#ff79c6">&lt;mvc:message-converters&gt;</span>
        <span style="color:#ff79c6">&lt;ref</span> <span style="color:#50fa7b">bean=</span><span style="color:#f1fa8c">&#34;fastJsonHttpMessageConverter&#34;</span><span style="color:#ff79c6">/&gt;</span>
    <span style="color:#ff79c6">&lt;/mvc:message-converters&gt;</span>
<span style="color:#ff79c6">&lt;/mvc:annotation-driven&gt;</span>
</code></pre></div><p>当然各位也可以使用注解的方式</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Configuration
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">SpringWebConfig</span> <span style="color:#8be9fd;font-style:italic">extends</span> WebMvcConfigurerAdapter <span style="color:#ff79c6">{</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">configureMessageConverters</span><span style="color:#ff79c6">(</span>List<span style="color:#ff79c6">&lt;</span>HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;&gt;</span> converters<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        FastJsonHttpMessageConverter converter <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> FastJsonHttpMessageConverter<span style="color:#ff79c6">();</span>
        FastJsonConfig config <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> FastJsonConfig<span style="color:#ff79c6">();</span>
        config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setSerializerFeatures</span><span style="color:#ff79c6">(</span>
                <span style="color:#6272a4">// 避免循环引用
</span><span style="color:#6272a4"></span>                SerializerFeature<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DisableCircularReferenceDetect</span><span style="color:#ff79c6">);</span>
        converter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFastJsonConfig</span><span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">);</span>
        converter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setDefaultCharset</span><span style="color:#ff79c6">(</span>Charset<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;UTF-8&#34;</span><span style="color:#ff79c6">));</span>
        List<span style="color:#ff79c6">&lt;</span>MediaType<span style="color:#ff79c6">&gt;</span> mediaTypeList <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ArrayList<span style="color:#ff79c6">&lt;&gt;();</span>
        mediaTypeList<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>MediaType<span style="color:#ff79c6">.</span><span style="color:#50fa7b">APPLICATION_JSON</span><span style="color:#ff79c6">);</span>
        converter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setSupportedMediaTypes</span><span style="color:#ff79c6">(</span>mediaTypeList<span style="color:#ff79c6">);</span>
        <span style="color:#6272a4">// 为什么不是直接add，这个在下文中会提到
</span><span style="color:#6272a4"></span>        converters<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">,</span> converter<span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>

<span style="color:#ff79c6">}</span>
</code></pre></div><p>两种方式其实都是将们自定义的HttpMessageConverter注入到Spring内部当中的messageConverts当中，效果是一样的。</p>
<h3 id="dispatcherservlet">DispatcherServlet</h3>
<p>对于这个类，我想我们应该是再熟悉不过了，即便没有看过源码。各位在刚学SpringMVC的时候，各类教程里面都是告诉你需要在web.xml配置文件当中配置这个类。这是因为DispatcherServlet这个类是作为SpringMVC所有的请求的一个入口类。当Tomcat将请求包装之后流转到HttpServlet当中，这个时候的HttpServlet实际上是Spring提供的FrameworkServlet，紧接着进入的doService方法则是由FrameworkServlet，也就是DispatcherServlet所实现。如图所示：

  <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b86ce56d2f3d463faa1e9101145300d8~tplv-k3u1fbpfcp-watermark.image" alt="">


那么在这个doDispatch方法里面，经过一层层调用，就会调用到HandlerMethodReturnValueHandlerComposite#handleReturnValue（中间的环节我就略过了，各位也可以自行DEBUG）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	@Override
	<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">handleReturnValue</span><span style="color:#ff79c6">(</span>Object returnValue<span style="color:#ff79c6">,</span> MethodParameter returnType<span style="color:#ff79c6">,</span>
			ModelAndViewContainer mavContainer<span style="color:#ff79c6">,</span> NativeWebRequest webRequest<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>

		HandlerMethodReturnValueHandler handler <span style="color:#ff79c6">=</span> selectHandler<span style="color:#ff79c6">(</span>returnValue<span style="color:#ff79c6">,</span> returnType<span style="color:#ff79c6">);</span>
		<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>handler <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
			<span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> IllegalArgumentException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Unknown return value type: &#34;</span> <span style="color:#ff79c6">+</span> returnType<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getParameterType</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">());</span>
		<span style="color:#ff79c6">}</span>
		handler<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handleReturnValue</span><span style="color:#ff79c6">(</span>returnValue<span style="color:#ff79c6">,</span> returnType<span style="color:#ff79c6">,</span> mavContainer<span style="color:#ff79c6">,</span> webRequest<span style="color:#ff79c6">);</span>
	<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="handlermethodreturnvaluehandlercomposite">HandlerMethodReturnValueHandlerComposite</h3>
<p>这里有一个selectHandler私有方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#8be9fd;font-style:italic">private</span> HandlerMethodReturnValueHandler <span style="color:#50fa7b">selectHandler</span><span style="color:#ff79c6">(</span>Object value<span style="color:#ff79c6">,</span> MethodParameter returnType<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
		<span style="color:#8be9fd">boolean</span> isAsyncValue <span style="color:#ff79c6">=</span> isAsyncReturnValue<span style="color:#ff79c6">(</span>value<span style="color:#ff79c6">,</span> returnType<span style="color:#ff79c6">);</span>
		<span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>HandlerMethodReturnValueHandler handler <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">returnValueHandlers</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
			<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>isAsyncValue <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!(</span>handler <span style="color:#ff79c6">instanceof</span> AsyncHandlerMethodReturnValueHandler<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
				<span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>
			<span style="color:#ff79c6">}</span>
			<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>handler<span style="color:#ff79c6">.</span><span style="color:#50fa7b">supportsReturnType</span><span style="color:#ff79c6">(</span>returnType<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
				<span style="color:#ff79c6">return</span> handler<span style="color:#ff79c6">;</span>
			<span style="color:#ff79c6">}</span>
		<span style="color:#ff79c6">}</span>
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
	<span style="color:#ff79c6">}</span>
</code></pre></div><p>SpringMVC里面内置了15个HandlerMethodReturnValueHandler，每一个HandlerMethodReturnValueHandler都实现了supportsReturnType。通过这个接口我们来确定在运行的时候是用哪一个处理器。这里我们来看下RequestResponseBodyMethodProcessor所实现的supportsReturnType方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	@Override
	<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">supportsReturnType</span><span style="color:#ff79c6">(</span>MethodParameter returnType<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">(</span>AnnotatedElementUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hasAnnotation</span><span style="color:#ff79c6">(</span>returnType<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getContainingClass</span><span style="color:#ff79c6">(),</span> ResponseBody<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">||</span>
				returnType<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hasMethodAnnotation</span><span style="color:#ff79c6">(</span>ResponseBody<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">));</span>
	<span style="color:#ff79c6">}</span>
</code></pre></div><p>可以看到，这里还是围绕着@ResponseBody这个注解来的。这下，以后面试官要是问你，为什么@ResponseBody是用来返回JSON数据的，那么，看到这个步骤，我们大概清楚，因为这个注解的存在，所以我们所使用的HandlerMethodReturnValueHandler选择的是RequestResponseBodyMethodProcessor。<!-- raw HTML omitted -->
既然确定了具体的处理器，那么我们就进入到它的handleReturnValue方法。</p>
<h3 id="requestresponsebodymethodprocessor">RequestResponseBodyMethodProcessor</h3>
<p>直接先看源码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	@Override
	<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">handleReturnValue</span><span style="color:#ff79c6">(</span>Object returnValue<span style="color:#ff79c6">,</span> MethodParameter returnType<span style="color:#ff79c6">,</span>
			ModelAndViewContainer mavContainer<span style="color:#ff79c6">,</span> NativeWebRequest webRequest<span style="color:#ff79c6">)</span>
			<span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> HttpMediaTypeNotAcceptableException<span style="color:#ff79c6">,</span> HttpMessageNotWritableException <span style="color:#ff79c6">{</span>

		mavContainer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setRequestHandled</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
		ServletServerHttpRequest inputMessage <span style="color:#ff79c6">=</span> createInputMessage<span style="color:#ff79c6">(</span>webRequest<span style="color:#ff79c6">);</span>
		ServletServerHttpResponse outputMessage <span style="color:#ff79c6">=</span> createOutputMessage<span style="color:#ff79c6">(</span>webRequest<span style="color:#ff79c6">);</span>

		<span style="color:#6272a4">// Try even with null return value. ResponseBodyAdvice could get involved.
</span><span style="color:#6272a4"></span>		writeWithMessageConverters<span style="color:#ff79c6">(</span>returnValue<span style="color:#ff79c6">,</span> returnType<span style="color:#ff79c6">,</span> inputMessage<span style="color:#ff79c6">,</span> outputMessage<span style="color:#ff79c6">);</span>
	<span style="color:#ff79c6">}</span>
</code></pre></div><p>这里其实也没什么好说的，就是直接调用了它所继承的抽象方法。</p>
<h3 id="abstractmessageconvertermethodprocessor">AbstractMessageConverterMethodProcessor</h3>
<p>进入到writeWithMessageConverters这个方法，我看来看到这其中的这一部分</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>selectedMediaType <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    selectedMediaType <span style="color:#ff79c6">=</span> selectedMediaType<span style="color:#ff79c6">.</span><span style="color:#50fa7b">removeQualityValue</span><span style="color:#ff79c6">();</span>
    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;</span> messageConverter <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">messageConverters</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>messageConverter <span style="color:#ff79c6">instanceof</span> GenericHttpMessageConverter<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(((</span>GenericHttpMessageConverter<span style="color:#ff79c6">)</span> messageConverter<span style="color:#ff79c6">).</span><span style="color:#50fa7b">canWrite</span><span style="color:#ff79c6">(</span>
                    declaredType<span style="color:#ff79c6">,</span> valueType<span style="color:#ff79c6">,</span> selectedMediaType<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// 写入之前执行动作
</span><span style="color:#6272a4"></span>                outputValue <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>T<span style="color:#ff79c6">)</span> getAdvice<span style="color:#ff79c6">().</span><span style="color:#50fa7b">beforeBodyWrite</span><span style="color:#ff79c6">(</span>outputValue<span style="color:#ff79c6">,</span> returnType<span style="color:#ff79c6">,</span> selectedMediaType<span style="color:#ff79c6">,</span>
                        <span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">&lt;?</span> <span style="color:#8be9fd;font-style:italic">extends</span> HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;&gt;)</span> messageConverter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">(),</span>
                        inputMessage<span style="color:#ff79c6">,</span> outputMessage<span style="color:#ff79c6">);</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>outputValue <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    addContentDispositionHeader<span style="color:#ff79c6">(</span>inputMessage<span style="color:#ff79c6">,</span> outputMessage<span style="color:#ff79c6">);</span>
                    <span style="color:#6272a4">// 具体的messageConverter进行写入
</span><span style="color:#6272a4"></span>                    <span style="color:#ff79c6">((</span>GenericHttpMessageConverter<span style="color:#ff79c6">)</span> messageConverter<span style="color:#ff79c6">).</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>
                            outputValue<span style="color:#ff79c6">,</span> declaredType<span style="color:#ff79c6">,</span> selectedMediaType<span style="color:#ff79c6">,</span> outputMessage<span style="color:#ff79c6">);</span>
                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isDebugEnabled</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
                        logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Written [&#34;</span> <span style="color:#ff79c6">+</span> outputValue <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;] as \&#34;&#34;</span> <span style="color:#ff79c6">+</span> selectedMediaType <span style="color:#ff79c6">+</span>
                                <span style="color:#f1fa8c">&#34;\&#34; using [&#34;</span> <span style="color:#ff79c6">+</span> messageConverter <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;]&#34;</span><span style="color:#ff79c6">);</span>
                    <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>messageConverter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">canWrite</span><span style="color:#ff79c6">(</span>valueType<span style="color:#ff79c6">,</span> selectedMediaType<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
            outputValue <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>T<span style="color:#ff79c6">)</span> getAdvice<span style="color:#ff79c6">().</span><span style="color:#50fa7b">beforeBodyWrite</span><span style="color:#ff79c6">(</span>outputValue<span style="color:#ff79c6">,</span> returnType<span style="color:#ff79c6">,</span> selectedMediaType<span style="color:#ff79c6">,</span>
                    <span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">&lt;?</span> <span style="color:#8be9fd;font-style:italic">extends</span> HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;&gt;)</span> messageConverter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">(),</span>
                    inputMessage<span style="color:#ff79c6">,</span> outputMessage<span style="color:#ff79c6">);</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>outputValue <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                addContentDispositionHeader<span style="color:#ff79c6">(</span>inputMessage<span style="color:#ff79c6">,</span> outputMessage<span style="color:#ff79c6">);</span>
                <span style="color:#ff79c6">((</span>HttpMessageConverter<span style="color:#ff79c6">)</span> messageConverter<span style="color:#ff79c6">).</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>outputValue<span style="color:#ff79c6">,</span> selectedMediaType<span style="color:#ff79c6">,</span> outputMessage<span style="color:#ff79c6">);</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isDebugEnabled</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
                    logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Written [&#34;</span> <span style="color:#ff79c6">+</span> outputValue <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;] as \&#34;&#34;</span> <span style="color:#ff79c6">+</span> selectedMediaType <span style="color:#ff79c6">+</span>
                            <span style="color:#f1fa8c">&#34;\&#34; using [&#34;</span> <span style="color:#ff79c6">+</span> messageConverter <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;]&#34;</span><span style="color:#ff79c6">);</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>看上去这段代码好像很麻烦，但是实际上关键的就两个步骤：</p>
<ol>
<li>getAdvice().beforeBodyWrite()</li>
<li>write()
没错，write方法就是我们返回JSON数据写入IO流，而getAdvice().beforeBodyWrite()就是在写入之前可以对数据进行处理的前置方法，也是Spring给开发者留下的钩子。所以这就可能是一个可以考虑的地方，在下面还会提到，我们继续往下看。<!-- raw HTML omitted --></li>
</ol>
<h3 id="fastjsonhttpmessageconverter">FastJsonHttpMessageConverter</h3>
<p>我们继续回到上面的for循环当中，看看这个this.messageConverters

  <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5d148ed8c99041ceadc9168f07c13431~tplv-k3u1fbpfcp-watermark.image" alt="">

</p>
<h5 id="为什么是fastjsonhttpmessageconverter">为什么是FastJsonHttpMessageConverter</h5>
<p>我们可以看到，SpringMVC内置了很多HttpMessageConverter。this.messageConverters是在Spring容器启动的时候就会进行加载设置，先加载系统内置的，最后才会加载我们自定义的，也就是我们的主角FastJsonHttpMessageConverter。这些知道为什么我要写成</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">converters<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">,</span> converter<span style="color:#ff79c6">);</span>
</code></pre></div><p>目的就是为了在遍历的时候首先使用FastJsonHttpMessageConverter，不然默认执行的就是MappingJackson2HttpMessageConverter。（希望有朝一日，FastJsonHttpMessageConverter也能成为内置的转换器）
<!-- raw HTML omitted --></p>
<h4 id="快说说thismessageconverters是怎么加载的">快说说this.messageConverters是怎么加载的</h4>
<p>好吧，上面我一笔带过这个流程，想偷个懒，可还是被你们的好奇心发现了。上面说到，this.messageConverters是在Spring容器启动的时候就会进行加载设置，先加载系统内置的，最后才会加载我们自定义的。那它是怎么加载的呢？
<!-- raw HTML omitted -->
我们先来DUBUG一下，从结果往前推。看看这里的堆栈

  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d04b46b1f11c43949a421988015e57a1~tplv-k3u1fbpfcp-watermark.image" alt="">


可以发现传入的converters这个列表里面已经有了内置的10个转换器了，那到这里就说明是先赋值系统内置的转换器，然后再轮到我们自定义的。<!-- raw HTML omitted -->
额，这样的解释我猜你们显然是不尽兴的，那么我们继续往前推，看看是哪里的程序进入到这里:

  <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8cb298c5ce84c70b947cd6f710b93ca~tplv-k3u1fbpfcp-watermark.image" alt="">


我想看到这里，总该明白，这个this.delegates列表里面有两个WebMvcConfigurer的实现类，按照顺序进行遍历。可以看到我们自定义的WebMvcConfigurer是晚于Spring内置的WebMvcAutoConfigurationAdapter。<!-- raw HTML omitted -->
额，不是吧，竟然还会问为什么this.delegates里面的顺序是这样的？

  <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5857036053a4f2791a2471bcbcb0026~tplv-k3u1fbpfcp-watermark.image" alt="">


<!-- raw HTML omitted -->
那么我们看下上面是怎么给this.delegates进行赋值的

  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dcb295b257204fc9a67b28f202cda097~tplv-k3u1fbpfcp-watermark.image" alt="">


可以看到这个WebMvcConfigurer也是由外部传入的，我们看下是哪里传入的

  <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c87f91422eef434cb064daccf38c378e~tplv-k3u1fbpfcp-watermark.image" alt="">


我想这个写法就应该很明白了，根据Autowired将容器中的WebMvcConfigurer赋值到这个configurers当中，至于赋值过程中的顺序，则会参考是不是有@Order注解，我们可以看到Spring给我们提供的WebMvcAutoConfigurationAdapter上面写了@Order(0)。所以各位老板要是不想使用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">converters<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">,</span> converter<span style="color:#ff79c6">);</span>
</code></pre></div><p>这种写法而是直接add，那么可以在自定义的WebMvcConfigurer将优先级早于WebMvcAutoConfigurationAdapter也是可以的。

  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44d63fec34664268aa05d5136dc761ca~tplv-k3u1fbpfcp-watermark.image" alt="">

</p>
<h4 id="write做了什么事情呢">write做了什么事情呢</h4>
<p>既然上面已经解释了为什么是FastJsonHttpMessageConverter，那么接下来我们就可以来看它的write方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Override
<span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">writeInternal</span><span style="color:#ff79c6">(</span>Object object<span style="color:#ff79c6">,</span> HttpOutputMessage outputMessage<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> HttpMessageNotWritableException <span style="color:#ff79c6">{</span>

    ByteArrayOutputStream outnew <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">();</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        
        <span style="color:#6272a4">// ... 省略
</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd">int</span> len <span style="color:#ff79c6">=</span> JSON<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeJSONString</span><span style="color:#ff79c6">(</span>outnew<span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                fastJsonConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getCharset</span><span style="color:#ff79c6">(),</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                value<span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                fastJsonConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSerializeConfig</span><span style="color:#ff79c6">(),</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                <span style="color:#6272a4">//fastJsonConfig.getSerializeFilters(), //
</span><span style="color:#6272a4"></span>                allFilters<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toArray</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> SerializeFilter<span style="color:#ff79c6">[</span>allFilters<span style="color:#ff79c6">.</span><span style="color:#50fa7b">size</span><span style="color:#ff79c6">()]),</span>
                fastJsonConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDateFormat</span><span style="color:#ff79c6">(),</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                JSON<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT_GENERATE_FEATURE</span><span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                fastJsonConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSerializerFeatures</span><span style="color:#ff79c6">());</span>
                
       <span style="color:#6272a4">// ... 省略
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>JSONException ex<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> HttpMessageNotWritableException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Could not write JSON: &#34;</span> <span style="color:#ff79c6">+</span> ex<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMessage</span><span style="color:#ff79c6">(),</span> ex<span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
        outnew<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>


</code></pre></div><p>省略一些中间环节，最后它就是进行核心的JSON化操作。接下来就是看Fastjson在这个过程中是否给我们预留了上面类似的钩子。答应是肯定的，毕竟也是这么优秀的开源项目。直接上代码吧</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">JavaBeanSerializer</span> <span style="color:#8be9fd;font-style:italic">extends</span> SerializeFilterable <span style="color:#8be9fd;font-style:italic">implements</span> ObjectSerializer <span style="color:#ff79c6">{</span>

    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>JSONSerializer serializer<span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                          Object object<span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                          Object fieldName<span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                          Type fieldType<span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                          <span style="color:#8be9fd">int</span> features<span style="color:#ff79c6">,</span>
                          <span style="color:#8be9fd">boolean</span> unwrapped
        <span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
    
    	<span style="color:#6272a4">// 这里就是处理每一个key-value的过程
</span><span style="color:#6272a4"></span>    	Object originalValue <span style="color:#ff79c6">=</span> propertyValue<span style="color:#ff79c6">;</span>
		propertyValue <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">processValue</span><span style="color:#ff79c6">(</span>serializer<span style="color:#ff79c6">,</span> fieldSerializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fieldContext</span><span style="color:#ff79c6">,</span> object<span style="color:#ff79c6">,</span> fieldInfoName<span style="color:#ff79c6">,</span> propertyValue<span style="color:#ff79c6">,</span> features<span style="color:#ff79c6">);</span>
    
    <span style="color:#ff79c6">}</span>
    
    <span style="color:#8be9fd;font-style:italic">protected</span> Object <span style="color:#50fa7b">processValue</span><span style="color:#ff79c6">(</span>JSONSerializer jsonBeanDeser<span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                           BeanContext beanContext<span style="color:#ff79c6">,</span>
                           Object object<span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                           String key<span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                           Object propertyValue<span style="color:#ff79c6">,</span> <span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>                           <span style="color:#8be9fd">int</span> features<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                           
                           
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>jsonBeanDeser<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueFilters</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>ValueFilter valueFilter <span style="color:#ff79c6">:</span> jsonBeanDeser<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueFilters</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                propertyValue <span style="color:#ff79c6">=</span> valueFilter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">process</span><span style="color:#ff79c6">(</span>object<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">,</span> propertyValue<span style="color:#ff79c6">);</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>                      
    <span style="color:#ff79c6">}</span>

<span style="color:#ff79c6">}</span>
</code></pre></div><p>在Fastjson处理每一个key-value的时候，都会去执行这个valueFilters。所以我们只需要在配置FastJsonHttpMessageConverter的时候，带上我们自定义的ValueFilter,这样它就会进行处理。我们来看下这个接口</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">interface</span> <span style="color:#50fa7b">ValueFilter</span> <span style="color:#8be9fd;font-style:italic">extends</span> SerializeFilter <span style="color:#ff79c6">{</span>

    Object <span style="color:#50fa7b">process</span><span style="color:#ff79c6">(</span>Object object<span style="color:#ff79c6">,</span> String name<span style="color:#ff79c6">,</span> Object value<span style="color:#ff79c6">);</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>我们可以看到这个接口里面有一个process方法，所以我们也可以利用这个钩子，在输出JSON数据之前，对内容进行清除修改。</p>
<h3 id="那么怎么选择呢">那么怎么选择呢</h3>
<p>那么综合来看我们可以发现，整个流程当中会提到两个钩子</p>
<ol>
<li>SpringMVC写入之前的钩子</li>
<li>SpringMVC使用的Fastjson在写入JSON之前的钩子
那各位觉得应该要使用哪一个钩子呢？我个人觉得，是使用Fastjson的钩子。因为假如是用SpringMVC提供的钩子，当拿到对象之后，大概率是会使用反射的方式进行修改内容，而后续的序列化，不管是Fastjson还是Jackson也是会用到反射。这两轮的反射会对性能造成一定程度的影响，所以与其都要修改，不如就留在Fastjson的钩子中去处理。<!-- raw HTML omitted -->

  <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/972c13de474c437e9b7dc14bb687a4e1~tplv-k3u1fbpfcp-watermark.image" alt="">

</li>
</ol>
<h2 id="json数据请求">JSON数据请求</h2>
<p>说完了返回的这一层面，我们再来看看JSON数据请求的这一情况，能不能也有相关的解决方案。既然说到请求，那么我们还是要回归到上面我们讲的DispatcherServlet。</p>
<h3 id="dispatcherservlet-1">DispatcherServlet</h3>
<p>又回到这个类，这里我们就从doService入手，紧接着调用了doDispatch方法。（什么，你连为什么会走入doService都不知道，我……，出门左转找下Tomcat源码攻略）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * Exposes the DispatcherServlet-specific request attributes and delegates to {@link #doDispatch}
</span><span style="color:#6272a4"> * for the actual dispatching.
</span><span style="color:#6272a4"> */</span>
@Override
<span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">doService</span><span style="color:#ff79c6">(</span>HttpServletRequest request<span style="color:#ff79c6">,</span> HttpServletResponse response<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
	
	<span style="color:#6272a4">// 一些配置操作，这里忽略
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
		doDispatch<span style="color:#ff79c6">(</span>request<span style="color:#ff79c6">,</span> response<span style="color:#ff79c6">);</span>
	<span style="color:#ff79c6">}</span>
	<span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
		<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>WebAsyncUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getAsyncManager</span><span style="color:#ff79c6">(</span>request<span style="color:#ff79c6">).</span><span style="color:#50fa7b">isConcurrentHandlingStarted</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
			<span style="color:#6272a4">// Restore the original attribute snapshot, in case of an include.
</span><span style="color:#6272a4"></span>			<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>attributesSnapshot <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
				restoreAttributesAfterInclude<span style="color:#ff79c6">(</span>request<span style="color:#ff79c6">,</span> attributesSnapshot<span style="color:#ff79c6">);</span>
			<span style="color:#ff79c6">}</span>
		<span style="color:#ff79c6">}</span>
	<span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>在这个doDispatch方法里面呢，会去寻找对应的HandlerAdapter，也就是RequestMappingHandlerAdapter这个适配器。

  <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a97f7c8bf8c3424bbe721e1b27e37bfd~tplv-k3u1fbpfcp-watermark.image" alt="">


也就是上面图片中的第二个小方框。至于第一个，就是大家经常背的面试题，问SpringMVC请求处理流程，其中获取接口处理器就是在这个地方。当然这里只是提一下。
<!-- raw HTML omitted -->
那么是怎么决定是RequestMappingHandlerAdapter呢，我们看下这个getHandlerAdapter方法

  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af7318e113f744e4b774e78c1849cc49~tplv-k3u1fbpfcp-watermark.image" alt="">


可以看到，Spring容器内提供了4个内置的handlerAdapters。RequestMappingHandlerAdapter并没有重写这个supports方法，所以使用的是抽象方法AbstractHandlerMethodAdapter当中的supports方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#6272a4">/**
</span><span style="color:#6272a4">	 * This implementation expects the handler to be an {@link HandlerMethod}.
</span><span style="color:#6272a4">	 * @param handler the handler instance to check
</span><span style="color:#6272a4">	 * @return whether or not this adapter can adapt the given handler
</span><span style="color:#6272a4">	 */</span>
	@Override
	<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">supports</span><span style="color:#ff79c6">(</span>Object handler<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">(</span>handler <span style="color:#ff79c6">instanceof</span> HandlerMethod <span style="color:#ff79c6">&amp;&amp;</span> supportsInternal<span style="color:#ff79c6">((</span>HandlerMethod<span style="color:#ff79c6">)</span> handler<span style="color:#ff79c6">));</span>
	<span style="color:#ff79c6">}</span>
</code></pre></div><p>RequestMappingHandlerAdapter重写了supportsInternal方法，恒等于true</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * Always return {@code true} since any method argument and return value
</span><span style="color:#6272a4"> * type will be processed in some way. A method argument not recognized
</span><span style="color:#6272a4"> * by any HandlerMethodArgumentResolver is interpreted as a request parameter
</span><span style="color:#6272a4"> * if it is a simple type, or as a model attribute otherwise. A return value
</span><span style="color:#6272a4"> * not recognized by any HandlerMethodReturnValueHandler will be interpreted
</span><span style="color:#6272a4"> * as a model attribute.
</span><span style="color:#6272a4"> */</span>
@Override
<span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">supportsInternal</span><span style="color:#ff79c6">(</span>HandlerMethod handlerMethod<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>大家也可以看看上面的英文注释，还是比较易懂的。<!-- raw HTML omitted -->而前者，在封装的Http请求的时候本就是使用HandlerMethod作为其中的处理类。所以是结合这些因素就决定是RequestMappingHandlerAdapter作为适配器。</p>
<h3 id="invocablehandlermethod">InvocableHandlerMethod</h3>
<p>画风一转，我们来到了这个类。在确定RequestMappingHandlerAdapter作为处理类适配器之后，紧接着会进入一系列操作。其他操作我们在这里不做关心，因为我们关心的是对于参数部分的操作。

  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9affa4f43b44919a1cd0a91032dd15c~tplv-k3u1fbpfcp-watermark.image" alt="">


这里的getMethodArgumentValues方法就是用来获取接口中的参数

  <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4d7eea630a9943acbb4e2c2acbbf2123~tplv-k3u1fbpfcp-watermark.image" alt="">


而具体的是由this.resolvers调用resolveArgument这个方法来处理</p>
<h3 id="handlermethodargumentresolvercomposite">HandlerMethodArgumentResolverComposite</h3>
<p>上面的this.resolvers就是这个类来着

  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/172f329b15e243acac2ce4cf6849084e~tplv-k3u1fbpfcp-watermark.image" alt="">


这里又需要进行getArgumentResolver来获取真正的参数处理器HandlerMethodArgumentResolver

  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1893438a4b2041d3953edce85515b06f~tplv-k3u1fbpfcp-watermark.image" alt="">


这里的缓存我就不多说了。系统里面提供了26个参数处理器。</p>
<h3 id="requestresponsebodymethodprocessor-1">RequestResponseBodyMethodProcessor</h3>
<p>
  <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11c208f316304e3ea498a77989c22d0f~tplv-k3u1fbpfcp-watermark.image" alt="">


我们在平常的开发当中，如果前端页面传的是一个json数据的话，我们会在SpringMVC的参数对象前面加上一个@RequestBody。以前学的时候，包括做的时候，反正只要加上这个注解，就可以接收到JSON数据了。那么今天我们终于可以知道，也正是因为有了这个注解的规范，流程上会根据supportsParameter接口方法来定位到这个处理器。（划重点，划重点，划重点）

  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d25e1b648bdc40d0b4e6b96d8254af9f~tplv-k3u1fbpfcp-watermark.image" alt="">


进入到resolveArgument，我们又看到了熟悉的东西。没错，这里的readWithMessageConverters又用到了我们之前说的MessageConverters。进入这个方法，看看它的实现</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Nullable
<span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> Object <span style="color:#50fa7b">readWithMessageConverters</span><span style="color:#ff79c6">(</span>HttpInputMessage inputMessage<span style="color:#ff79c6">,</span> MethodParameter parameter<span style="color:#ff79c6">,</span>
	Type targetType<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> HttpMediaTypeNotSupportedException<span style="color:#ff79c6">,</span> HttpMessageNotReadableException <span style="color:#ff79c6">{</span>

	<span style="color:#6272a4">// 之前的逻辑省略
</span><span style="color:#6272a4"></span>
	EmptyBodyCheckingHttpInputMessage message<span style="color:#ff79c6">;</span>
	<span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
		message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> EmptyBodyCheckingHttpInputMessage<span style="color:#ff79c6">(</span>inputMessage<span style="color:#ff79c6">);</span>

		<span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;</span> converter <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">messageConverters</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
			Class<span style="color:#ff79c6">&lt;</span>HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;&gt;</span> converterType <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">&lt;</span>HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;&gt;)</span> converter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">();</span>
			GenericHttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;</span> genericConverter <span style="color:#ff79c6">=</span>
					<span style="color:#ff79c6">(</span>converter <span style="color:#ff79c6">instanceof</span> GenericHttpMessageConverter <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">(</span>GenericHttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;)</span> converter <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
			<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>genericConverter <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">?</span> genericConverter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">canRead</span><span style="color:#ff79c6">(</span>targetType<span style="color:#ff79c6">,</span> contextClass<span style="color:#ff79c6">,</span> contentType<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span>
					<span style="color:#ff79c6">(</span>targetClass <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> converter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">canRead</span><span style="color:#ff79c6">(</span>targetClass<span style="color:#ff79c6">,</span> contentType<span style="color:#ff79c6">)))</span> <span style="color:#ff79c6">{</span>
				<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hasBody</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
					HttpInputMessage msgToUse <span style="color:#ff79c6">=</span>
							getAdvice<span style="color:#ff79c6">().</span><span style="color:#50fa7b">beforeBodyRead</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">,</span> parameter<span style="color:#ff79c6">,</span> targetType<span style="color:#ff79c6">,</span> converterType<span style="color:#ff79c6">);</span>
					body <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>genericConverter <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">?</span> genericConverter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span>targetType<span style="color:#ff79c6">,</span> contextClass<span style="color:#ff79c6">,</span> msgToUse<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span>
							<span style="color:#ff79c6">((</span>HttpMessageConverter<span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;)</span> converter<span style="color:#ff79c6">).</span><span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span>targetClass<span style="color:#ff79c6">,</span> msgToUse<span style="color:#ff79c6">));</span>
					body <span style="color:#ff79c6">=</span> getAdvice<span style="color:#ff79c6">().</span><span style="color:#50fa7b">afterBodyRead</span><span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">,</span> msgToUse<span style="color:#ff79c6">,</span> parameter<span style="color:#ff79c6">,</span> targetType<span style="color:#ff79c6">,</span> converterType<span style="color:#ff79c6">);</span>
				<span style="color:#ff79c6">}</span>
				<span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
					body <span style="color:#ff79c6">=</span> getAdvice<span style="color:#ff79c6">().</span><span style="color:#50fa7b">handleEmptyBody</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> message<span style="color:#ff79c6">,</span> parameter<span style="color:#ff79c6">,</span> targetType<span style="color:#ff79c6">,</span> converterType<span style="color:#ff79c6">);</span>
				<span style="color:#ff79c6">}</span>
				<span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
			<span style="color:#ff79c6">}</span>
		<span style="color:#ff79c6">}</span>
	<span style="color:#ff79c6">}</span>
	<span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException ex<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
		<span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> HttpMessageNotReadableException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;I/O error while reading input message&#34;</span><span style="color:#ff79c6">,</span> ex<span style="color:#ff79c6">,</span> inputMessage<span style="color:#ff79c6">);</span>
	<span style="color:#ff79c6">}</span>

	<span style="color:#6272a4">// 省略后置逻辑
</span><span style="color:#6272a4"></span>
	<span style="color:#ff79c6">return</span> body<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>可以看到这个里面的写法，跟之前的写发如出一辙，只是相比于返回JSON数据，多了一步后置处理。<!-- raw HTML omitted -->
那么由此我们也可以推测这里也存在两个钩子：</p>
<ol>
<li>SpringMVC提供的前置处理或者后置处理钩子处理数据</li>
<li>HttpMessageConverter提供的钩子处理</li>
</ol>
<h3 id="fastjsonhttpmessageconverter-1">FastJsonHttpMessageConverter</h3>
<p>又回到这个类。上面写到的是写入JSON，这里是从IO中读取JSON

  <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2da1064fffe54c47ba08433f80aca540~tplv-k3u1fbpfcp-watermark.image" alt="">


接下来就又回到我们平时使用的JSON.parseObject()方法了。这里提供了很多的配置，那么这里是否会有我们可能会用到的钩子呢。<!-- raw HTML omitted -->
这个答案是显然。跟着程序的执行，我们来到了Fastjson解析比较核心的部分

  <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f452179e4dd4c86a76cfb782089b38e~tplv-k3u1fbpfcp-watermark.image" alt="">


这一部分是从IO流中解析成字符串，紧接着调用parseObject

  <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef2cdc80216646c4a8282475f391eeba~tplv-k3u1fbpfcp-watermark.image" alt="">


这里提供了三种类型的processer，我也可以理解为是三种过滤器。很可惜这三种过滤器只有在找不到匹配的属性的时候才会进行调用。<!-- raw HTML omitted -->
那看来从Fastjson身上寻找钩子的方案可能行不通（当然，可能存在其他我不知道的钩子，只是按照我现在看下来可能有点鸡肋）</p>
<h3 id="getadvice">getAdvice()</h3>
<p>既然Fastjson这条路可能行不通，那么我们还是来看下SpringMVC提供的钩子吧。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">HttpInputMessage msgToUse <span style="color:#ff79c6">=</span>
		getAdvice<span style="color:#ff79c6">().</span><span style="color:#50fa7b">beforeBodyRead</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">,</span> parameter<span style="color:#ff79c6">,</span> targetType<span style="color:#ff79c6">,</span> converterType<span style="color:#ff79c6">);</span>
body <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>genericConverter <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">?</span> genericConverter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span>targetType<span style="color:#ff79c6">,</span> contextClass<span style="color:#ff79c6">,</span> msgToUse<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span>
		<span style="color:#ff79c6">((</span>HttpMessageConverter<span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;)</span> converter<span style="color:#ff79c6">).</span><span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span>targetClass<span style="color:#ff79c6">,</span> msgToUse<span style="color:#ff79c6">));</span>
body <span style="color:#ff79c6">=</span> getAdvice<span style="color:#ff79c6">().</span><span style="color:#50fa7b">afterBodyRead</span><span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">,</span> msgToUse<span style="color:#ff79c6">,</span> parameter<span style="color:#ff79c6">,</span> targetType<span style="color:#ff79c6">,</span> converterType<span style="color:#ff79c6">);</span>
</code></pre></div><p>这里的getAdvice()获取的类型是RequestResponseBodyAdviceChain，它是AbstractMessageConverterMethodArgumentResolver当中的属性，所以我们只要关注下它是如何被赋值的（总感觉又要被你们坑了）。<!-- raw HTML omitted -->

  <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bbfeaa8831934c00a6b5e6121c524658~tplv-k3u1fbpfcp-watermark.image" alt="">


从源码来看，是在构造函数里面进行赋值的，那么接着看看是从哪里进行传入参数的

  <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5be55d18bbf46e1b2507fe2a9666970~tplv-k3u1fbpfcp-watermark.image" alt="">


根据DEBUG的堆栈情况，可以跟踪到这个，那么这里的this.requestResponseBodyAdvice是怎么赋值的呢？系统会给我们自动装载JsonViewRequestBodyAdvice和JsonViewResponseBodyAdvice，这里我就不进行展开，我们就来看下是否可以赋值我们自定义的钩子。接着往堆栈上走，我们可以看下这个afterPropertiesSet。

  <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6fdb51bc99a44fe99d2641d34f61ce77~tplv-k3u1fbpfcp-watermark.image" alt="">


DEBUG这个时候是定在了第561行，这个地方就是装载系统提供的Advice。这个时候不知道大家是否留意到这个方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// Do this first, it may add ResponseBody advice beans
</span><span style="color:#6272a4"></span>initControllerAdviceCache<span style="color:#ff79c6">();</span>
</code></pre></div><p>尤其是上面的这个注释，似乎这个地方有我们想要的

  <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7a934588dc774ac9be943fe83a68fdbb~tplv-k3u1fbpfcp-watermark.image" alt="">


这个方法里面，首先是寻找系统中的ControllerAdviceBean，寻找的依据还是根据这个ControllerAdviceBean.findAnnotatedBeans(getApplicationContext());</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * Find beans annotated with {@link ControllerAdvice @ControllerAdvice} in the
</span><span style="color:#6272a4"> * given {@link ApplicationContext} and wrap them as {@code ControllerAdviceBean}
</span><span style="color:#6272a4"> * instances.
</span><span style="color:#6272a4"> * &lt;p&gt;As of Spring Framework 5.2, the {@code ControllerAdviceBean} instances
</span><span style="color:#6272a4"> * in the returned list are sorted using {@link OrderComparator#sort(List)}.
</span><span style="color:#6272a4"> * @see #getOrder()
</span><span style="color:#6272a4"> * @see OrderComparator
</span><span style="color:#6272a4"> * @see Ordered
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> List<span style="color:#ff79c6">&lt;</span>ControllerAdviceBean<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">findAnnotatedBeans</span><span style="color:#ff79c6">(</span>ApplicationContext context<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
	List<span style="color:#ff79c6">&lt;</span>ControllerAdviceBean<span style="color:#ff79c6">&gt;</span> adviceBeans <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ArrayList<span style="color:#ff79c6">&lt;&gt;();</span>
	<span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>String name <span style="color:#ff79c6">:</span> BeanFactoryUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">beanNamesForTypeIncludingAncestors</span><span style="color:#ff79c6">(</span>context<span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
		<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>ScopedProxyUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isScopedTarget</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
			ControllerAdvice controllerAdvice <span style="color:#ff79c6">=</span> context<span style="color:#ff79c6">.</span><span style="color:#50fa7b">findAnnotationOnBean</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">,</span> ControllerAdvice<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
			<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>controllerAdvice <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
				<span style="color:#6272a4">// Use the @ControllerAdvice annotation found by findAnnotationOnBean()
</span><span style="color:#6272a4"></span>				<span style="color:#6272a4">// in order to avoid a subsequent lookup of the same annotation.
</span><span style="color:#6272a4"></span>				adviceBeans<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ControllerAdviceBean<span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">,</span> context<span style="color:#ff79c6">,</span> controllerAdvice<span style="color:#ff79c6">));</span>
			<span style="color:#ff79c6">}</span>
		<span style="color:#ff79c6">}</span>
	<span style="color:#ff79c6">}</span>
	OrderComparator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sort</span><span style="color:#ff79c6">(</span>adviceBeans<span style="color:#ff79c6">);</span>
	<span style="color:#ff79c6">return</span> adviceBeans<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>可以看到这里是说，主要是根据@ControllerAdvice这个注解来定位到这个类，并且封装成ControllerAdviceBean对象。<!-- raw HTML omitted -->
我们再回到上面那个图，如果是实现了RequestBodyAdvice或者ResponseBodyAdvice接口的类，就会加入到requestResponseBodyAdviceBeans这个列表当中，并且会将这个Advice复制到我们上面说的this.requestResponseBodyAdvice，并且，是放在首位！可见，如果我们实现了自定义的Advice，Spring是希望优先执行我们的Advice。此外，我们可以看到这里也有ResponseBodyAdvice，没错，在上面没有选用的JSON数据返回所涉及到的钩子，也是在这个地方进行赋值的。
<!-- raw HTML omitted -->
为此，我们可以简单实现下这一Advice</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@RestControllerAdvice
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">XssRequestControllerAdvice</span> <span style="color:#8be9fd;font-style:italic">implements</span> RequestBodyAdvice <span style="color:#ff79c6">{</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 默认XSS过滤处理白名单
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd;font-style:italic">static</span> Whitelist DEFAULT_WHITE_LIST <span style="color:#ff79c6">=</span> Whitelist<span style="color:#ff79c6">.</span><span style="color:#50fa7b">relaxed</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">addAttributes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;:all&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;style&#34;</span><span style="color:#ff79c6">);</span>


    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">supports</span><span style="color:#ff79c6">(</span>MethodParameter methodParameter<span style="color:#ff79c6">,</span> Type targetType<span style="color:#ff79c6">,</span> Class<span style="color:#ff79c6">&lt;?</span> <span style="color:#8be9fd;font-style:italic">extends</span> HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;&gt;</span> converterType<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> methodParameter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hasParameterAnnotation</span><span style="color:#ff79c6">(</span>RequestBody<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> Object <span style="color:#50fa7b">handleEmptyBody</span><span style="color:#ff79c6">(</span>Object body<span style="color:#ff79c6">,</span> HttpInputMessage inputMessage<span style="color:#ff79c6">,</span> MethodParameter parameter<span style="color:#ff79c6">,</span> Type targetType<span style="color:#ff79c6">,</span> Class<span style="color:#ff79c6">&lt;?</span> <span style="color:#8be9fd;font-style:italic">extends</span> HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;&gt;</span> converterType<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> body<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> HttpInputMessage <span style="color:#50fa7b">beforeBodyRead</span><span style="color:#ff79c6">(</span>HttpInputMessage inputMessage<span style="color:#ff79c6">,</span> MethodParameter parameter<span style="color:#ff79c6">,</span> Type targetType<span style="color:#ff79c6">,</span> Class<span style="color:#ff79c6">&lt;?</span> <span style="color:#8be9fd;font-style:italic">extends</span> HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;&gt;</span> converterType<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> HttpInputMessage<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
            @Override
            <span style="color:#8be9fd;font-style:italic">public</span> InputStream <span style="color:#50fa7b">getBody</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
                String bodyStr <span style="color:#ff79c6">=</span> IOUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span>inputMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBody</span><span style="color:#ff79c6">(),</span><span style="color:#f1fa8c">&#34;utf-8&#34;</span><span style="color:#ff79c6">);</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>StringUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isNotEmpty</span><span style="color:#ff79c6">(</span>bodyStr<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
                    bodyStr <span style="color:#ff79c6">=</span> StringUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">trim</span><span style="color:#ff79c6">(</span>Jsoup<span style="color:#ff79c6">.</span><span style="color:#50fa7b">clean</span><span style="color:#ff79c6">(</span>bodyStr<span style="color:#ff79c6">,</span> DEFAULT_WHITE_LIST<span style="color:#ff79c6">));</span>
                <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">return</span> IOUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toInputStream</span><span style="color:#ff79c6">(</span>bodyStr<span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;utf-8&#34;</span><span style="color:#ff79c6">);</span>
            <span style="color:#ff79c6">}</span>

            @Override
            <span style="color:#8be9fd;font-style:italic">public</span> HttpHeaders <span style="color:#50fa7b">getHeaders</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">return</span> inputMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getHeaders</span><span style="color:#ff79c6">();</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">};</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> Object <span style="color:#50fa7b">afterBodyRead</span><span style="color:#ff79c6">(</span>Object body<span style="color:#ff79c6">,</span> HttpInputMessage inputMessage<span style="color:#ff79c6">,</span> MethodParameter parameter<span style="color:#ff79c6">,</span> Type targetType<span style="color:#ff79c6">,</span> Class<span style="color:#ff79c6">&lt;?</span> <span style="color:#8be9fd;font-style:italic">extends</span> HttpMessageConverter<span style="color:#ff79c6">&lt;?&gt;&gt;</span> converterType<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> body<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>这边我重写了beforeBodyRead。从IO中读取字符串，在进行XSS数据清洗之后，并且再输出成IO流。虽然，在read部分又会进行一次IO流的读取。</p>
<h1 id="小结">小结</h1>
<p>通过上面的一系列源码探索（这波探索真TM多），主要是针对JSON数据的XSS过滤方案的探索与构思。最后这个需求我做了如下的方案：</p>
<ol>
<li>提供XssFilter进行XSS的数据过滤，这个是为了应对form表单提交的请求方式</li>
<li>提供XssRequestControllerAdvice和FastJsonXssValueFilter分别对请求和相应中的数据进行XSS过滤，这个是为了应对JSON数据的请求方式，前者可以防止后来的XSS数据写入，后者可以过滤已经存在系统当中的XSS脏数据，并且用户进行保存操作就可以纠正XSS数据。</li>
</ol>
<h1 id="最后">最后</h1>
<p>如果我的文章对你有所帮助，还希望各位大佬$\color{red}{点个关注}$ $\color{red}{点个赞}$，再次感谢大家的支持！<!-- raw HTML omitted -->
这里也附上我的Github地址:https://github.com/showyool/juejin.git</p>


                
                
<div class="entry-shang text-center">
    
	    <p> 「如果这篇文章对你有用,请随意打赏」</p>
	
	<button class="zs show-zs btn btn-bred">赞赏支持</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">×</button>
		<span class="author"><a href="http://showyool.github.io/"><img src="/img/favicon.png" />Showyool个人博客</a></span>
        
	        <p class="tip"><i></i><span>如果这篇文章对你有用,请随意打赏</span></p>
		
 
	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2元</button>
			<button class="btn btn-blink" data-num="5">5元</button>
			<button class="btn btn-blink" data-num="10">10元</button>
			<button class="btn btn-blink" data-num="50">50元</button>
			<button class="btn btn-blink" data-num="100">100元</button>
			<button class="btn btn-blink" data-num="1">任意金额</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2元</button>
			<p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
			<img src="/img/reward/wechat-2.png"  id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
		<label><input type="radio" name="zs-type" value="wechat" class="zs-type" checked="checked"><span ><span class="zs-wechat"><img src="/img/reward/wechat-btn.png"/></span></label>
		<label><input type="radio" name="zs-type" value="alipay" class="zs-type" class="zs-alipay"><img src="/img/reward/alipay-btn.png"/></span></label>
	</div>
</div>
<script type="text/javascript" src="/js/reward.js"></script>

                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/6893685346228240398/" data-toggle="tooltip" data-placement="top" title="记一次微服务项目迁移拆分的过程">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Showyool个人博客" >
                           <span class="fa-stack fa-lg">
                               <i class="fa fa-circle fa-stack-2x"></i>
                               <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    
                    <li>
                        <a href="mailto:mengyirunian@outlook.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/showyool">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Showyool个人博客 2021
                    <br>
                    
                    
                        
                        
                        
                    
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






</body>
</html>
